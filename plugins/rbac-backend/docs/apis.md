# APIs

## Requirements

To access the APIs for the RBAC Backend plugin, a user will need to have admin access. Refer to the [README](../README.md#configure-policy-admins) on how to set up admin access.

Each endpoint also requires an Authorization header with the Bearer token that was generated by Backstage. To access this token, traverse to your deployed instance and inspect the web page. Here are two places and example network calls that will have the Bearer token

- From the Homepage, the network call `query?term=`

- From the Catalog, any network call with `entity-facets`

## Role

### GET role

GET </api/permission/roles>

Lists all roles.

Returns:

```json
[
  {
    "memberReferences": ["user:default/adam"],
    "name": "role:default/rbac_admin",
    "metadata": {
      "source": "configuration",
      "description": null
    }
  },
  {
    "memberReferences": ["group:default/janus-authors", "user:default/matt"],
    "name": "role:default/test",
    "metadata": {
      "source": "csv-file",
      "description": null
    }
  }
]
```

---

GET </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test>

List the single role and the members associated with that role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Returns:

```json
[
  {
    "memberReferences": ["group:default/janus-authors", "user:default/matt"],
    "name": "role:default/test",
    "metadata": {
      "source": "csv-file",
      "description": null
    }
  }
]
```

---

### POST role

POST </api/permission/roles>

Creates a new role.

Request Parameters:

| Parameter name       | Description                                                      | Type   |
| -------------------- | ---------------------------------------------------------------- | ------ |
| memberReferences     | users / groups to be added to the role `<kind>:<default>/<name>` | Array  |
| name                 | name of the role                                                 | String |
| metadata.description | description of the role                                          | String |

body:

```json
{
  "memberReferences": ["group:default/test"],
  "name": "role:default/test_admin",
  "metadata": {
    "description": "This is a test admin role"
  }
}
```

Returns a status code of 201 upon success.

---

### PUT role

PUT </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin>

Updates a specified role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Request Parameters for oldRole and newRole:

| Parameter name       | Description                                                      | Type   |
| -------------------- | ---------------------------------------------------------------- | ------ |
| memberReferences     | users / groups to be added to the role `<kind>:<default>/<name>` | Array  |
| name                 | name of the role                                                 | String |
| metadata.description | description of the role                                          | String |

body:

```json
{
  "oldRole": {
    "memberReferences": ["group:default/test"],
    "name": "role:default/test_admin",
    "metadata": {
      "description": "This is a test admin role"
    }
  },
  "newRole": {
    "memberReferences": ["group:default/test", "user:default/test2"],
    "name": "role:default/test_admin",
    "metadata": {
      "description": "This is a test admin role with a group and user"
    }
  }
}
```

Returns a status code of 200 upon success.

---

### DELETE role

DELETE </api/permission/roles/:kind/:namespace/:name?memberReferences=VALUE>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin?memberReferences=user:default/test2>

Deletes a single user / group from a role.

Request Parameters:

| Parameter name   | Description                                                      | Type   |
| ---------------- | ---------------------------------------------------------------- | ------ |
| kind             | role                                                             | String |
| namespace        | Namespace of the role                                            | String |
| name             | name of the role                                                 | String |
| memberReferences | users / groups to be added to the role `<kind>:<default>/<name>` | String |
| name             | name of the role                                                 | String |

before:

```json
{
  "memberReferences": ["group:default/test, user:default/test2"],
  "name": "role:default/test_admin",
  "metadata": {
    "description": "This is a test admin role with a group and user"
  }
}
```

after:

```json
{
  "memberReferences": ["group:default/test"],
  "name": "role:default/test_admin",
  "metadata": {
    "description": "This is a test admin role with a group and user"
  }
}
```

Returns a status code of 204 upon success.

---

DELETE </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin>

Deletes a single role and all users associated with that role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Returns a status code of 204 upon success.

---

## Permission

### GET permission

GET </api/permission/policies>

Lists all permission polices.

Returns:

```json
[
  {
    "entityReference": "role:default/test",
    "permission": "catalog-entity",
    "policy": "read",
    "effect": "allow",
    "metadata": {
      "source": "csv-file"
    }
  },
  {
    "entityReference": "role:default/test",
    "permission": "catalog.entity.create",
    "policy": "create",
    "effect": "allow",
    "metadata": {
      "source": "csv-file"
    }
  },
  ...
]
```

---

GET </api/permission/policies/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/policies/role/default/test>

List permission policies related to the specified entity reference `<kind>:<default>/<name>`.

Request parameters:

| Parameter name | Description             | Type   |
| -------------- | ----------------------- | ------ |
| kind           | Kind of the entity      | String |
| namespace      | Namespace of the entity | String |
| name           | Username of the entity  | String |

Returns:

```json
[
  {
    "entityReference": "role:default/test",
    "permission": "catalog-entity",
    "policy": "read",
    "effect": "allow",
    "metadata": {
      "source": "csv-file"
    }
  },
  {
    "entityReference": "role:default/test",
    "permission": "catalog.entity.create",
    "policy": "create",
    "effect": "allow",
    "metadata": {
      "source": "csv-file"
    }
  }
]
```

---

### POST permission

POST </api/permission/policies>

Creates one or more permission policies for a specified entity.

Request parameters:

| Parameter name  | Description                                                                   | Type   |
| --------------- | ----------------------------------------------------------------------------- | ------ |
| entityReference | Entity `<kind>:<default>/<name>`                                              | String |
| permission      | Permission from a specific plugin, Resource type or name                      | String |
| policy          | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect          | `allow` or `deny`                                                             | String |

body:

```json
[
  {
    "entityReference": "role:default/test",
    "permission": "catalog-entity",
    "policy": "delete",
    "effect": "allow"
  }
]
```

Returns a status code of 201 upon success.

---

### PUT permission

PUT </api/permission/policies/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/policies/role/default/test>

Updates one or more permission policies for a specified entity.

Request parameters:

| Parameter name | Description             | Type   |
| -------------- | ----------------------- | ------ |
| kind           | Kind of the entity      | String |
| namespace      | Namespace of the entity | String |
| name           | Username of the entity  | String |

Request parameters for oldPolicy and newPolicy objects:

| Parameter name | Description                                                                   | Type   |
| -------------- | ----------------------------------------------------------------------------- | ------ |
| permission     | Permission from a specific plugin, Resource type or name                      | String |
| policy         | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect         | `allow` or `deny`                                                             | String |

body:

```json
{
  "oldPolicy": [
    {
      "permission": "catalog-entity",
      "policy": "read",
      "effect": "allow"
    },
    {
      "permission": "catalog.entity.create",
      "policy": "create",
      "effect": "allow"
    }
  ],
  "newPolicy": [
    {
      "permission": "catalog-entity",
      "policy": "read",
      "effect": "deny"
    },
    {
      "permission": "policy-entity",
      "policy": "create",
      "effect": "allow"
    }
  ]
}
```

Returns a status code of 200 upon success.

---

### Delete permission

DELETE </api/permission/policies/:kind/:namespace/:name?permission=VALUE1&policy=VALUE2&effect=VALUE3>
ex. <http://localhost:7007/api/permission/policies/role/default/test?permission=catalog-entity&policy=read&effect=allow>

Deletes a permission policy of a specified entity.

Request Parameters:

| Parameter name | Description                                                                   | Type   |
| -------------- | ----------------------------------------------------------------------------- | ------ |
| kind           | Kind of the entity                                                            | String |
| namespace      | Namespace of the entity                                                       | String |
| name           | Username of the entity                                                        | String |
| permission     | Permission from a specific plugin, Resource type or name                      | String |
| policy         | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect         | `allow` or `deny`                                                             | String |

Returns a status code of 204 upon success.

---

## Plugin

### GET plugin permission policies

GET </api/permission/plugins/policies>

Lists all plugin permission policies from plugins installed in your Backstage instance.

Returns:

```json
[
  {
    "pluginId": "catalog",
    "policies": [
      {
        "isResourced": true,
        "permission": "catalog-entity",
        "policy": "read"
      },
      {
        "isResourced": false,
        "permission": "catalog.entity.create",
        "policy": "create"
      },
      {
        "isResourced": true,
        "permission": "catalog-entity",
        "policy": "delete"
      },
      {
        "isResourced": true,
        "permission": "catalog-entity",
        "policy": "update"
      },
      {
        "isResourced": false,
        "permission": "catalog.location.read",
        "policy": "read"
      },
      {
        "isResourced": false,
        "permission": "catalog.location.create",
        "policy": "create"
      },
      {
        "isResourced": false,
        "permission": "catalog.location.delete",
        "policy": "delete"
      }
    ]
  },
  ...
]
```

---

## Conditions

The Backstage permission framework provides conditions, and the RBAC backend plugin supports this feature. Conditions work like content filters for Backstage resources (provided by plugins). The RBAC backend API stores conditions assigned to the role in the database. When a user requests access to the frontend resources, the RBAC backend API searches for corresponding conditions and delegates the condition for this resource to the corresponding plugin by its plugin ID. If a user was assigned to multiple roles, and each of these roles contains its own condition, the RBAC backend merges conditions using the anyOf criteria.

The corresponding plugin analyzes conditional parameters and makes a decision about which part of the content the user should see. Consequently, the user can view not all resource content but only some allowed parts. The RBAC backend plugin supports conditions bounded to the RBAC role.

A Backstage condition can be a simple condition with a rule and parameters. But also a Backstage condition could consists of a parameter or an array of parameters joined by criteria. The list of supported conditional criteria includes:

- allOf
- anyOf
- not

The plugin defines the supported condition parameters. API users can retrieve the conditional object schema from the RBAC API endpoint to determine how to build a condition JSON object and utilize it through the RBAC backend plugin API.

The structure of the condition JSON object is as follows:

| Json field        | Description                                                           | Type         |
| ----------------- | --------------------------------------------------------------------- | ------------ |
| result            | Always has the value "CONDITIONAL"                                    | String       |
| roleEntityRef     | String entity reference to the RBAC role ('role:default/dev')         | String       |
| pluginId          | Corresponding plugin ID (e.g., "catalog")                             | String       |
| permissionMapping | Array permission actions (['read', 'update', 'delete'])               | String array |
| resourceType      | Resource type provided by the plugin (e.g., "catalog-entity")         | String       |
| conditions        | Condition JSON with parameters or array parameters joined by criteria | JSON         |

### GET </plugins/condition-rules>

GET </plugins/condition-rules>

Provides condition parameters schemas.

```json
[
   {
      "pluginId": "catalog",
      "rules": [
         {
            "name": "HAS_ANNOTATION",
            "description": "Allow entities with the specified annotation",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "annotation": {
                     "type": "string",
                     "description": "Name of the annotation to match on"
                  },
                  "value": {
                     "type": "string",
                     "description": "Value of the annotation to match on"
                  }
               },
               "required": [
                  "annotation"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         },
         {
            "name": "HAS_LABEL",
            "description": "Allow entities with the specified label",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "label": {
                     "type": "string",
                     "description": "Name of the label to match on"
                  }
               },
               "required": [
                  "label"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         },
         {
            "name": "HAS_METADATA",
            "description": "Allow entities with the specified metadata subfield",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "key": {
                     "type": "string",
                     "description": "Property within the entities metadata to match on"
                  },
                  "value": {
                     "type": "string",
                     "description": "Value of the given property to match on"
                  }
               },
               "required": [
                  "key"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         },
         {
            "name": "HAS_SPEC",
            "description": "Allow entities with the specified spec subfield",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "key": {
                     "type": "string",
                     "description": "Property within the entities spec to match on"
                  },
                  "value": {
                     "type": "string",
                     "description": "Value of the given property to match on"
                  }
               },
               "required": [
                  "key"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         },
         {
            "name": "IS_ENTITY_KIND",
            "description": "Allow entities matching a specified kind",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "kinds": {
                     "type": "array",
                     "items": {
                        "type": "string"
                     },
                     "description": "List of kinds to match at least one of"
                  }
               },
               "required": [
                  "kinds"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         },
         {
            "name": "IS_ENTITY_OWNER",
            "description": "Allow entities owned by a specified claim",
            "resourceType": "catalog-entity",
            "paramsSchema": {
               "type": "object",
               "properties": {
                  "claims": {
                     "type": "array",
                     "items": {
                        "type": "string"
                     },
                     "description": "List of claims to match at least one on within ownedBy"
                  }
               },
               "required": [
                  "claims"
               ],
               "additionalProperties": false,
               "$schema": "http://json-schema.org/draft-07/schema#"
            }
         }
      ]
   }
   ... <another plugin condition parameter schemas>
]
```

From this condition schema, the RBAC backend API user can determine how to build a condition JSON object.

For example, consider a condition without criteria: displaying catalogs only if the user is a member of the owner group. The Catalog plugin schema "IS_ENTITY_OWNER" can be utilized to achieve this goal. To construct the condition JSON object based on this schema, the following information should be used:

- rule: the parameter name is "IS_ENTITY_OWNER" in this case
- resourceType: "catalog-entity"
- criteria: in this example, criteria are not used since we need to use only one conditional parameter
- params: from the schema, it is evident that it should be an object named "claims" with a string array. This string array constitutes a list of user or group string entity references.

Based on the above schema condition is:

```json
{
  "rule": "IS_ENTITY_OWNER",
  "resourceType": "catalog-entity",
  "params": {
    "claims": ["group:default/team-a"]
  }
}
```

To utilize this condition to the RBAC REST api you need to wrap it with more info

```json
{
  "result": "CONDITIONAL",
  "roleEntityRef": "role:default/test",
  "pluginId": "catalog",
  "resourceType": "catalog-entity",
  "permissionMapping": ["read"],
  "conditions": {
    "rule": "IS_ENTITY_OWNER",
    "resourceType": "catalog-entity",
    "params": {
      "claims": ["group:default/team-a"]
    }
  }
}
```

**Example condition with criteria**: display catalogs only if user is a member of owner group "OR" display list of all catalog user groups.

We can reuse previous condition parameter to display catalogs only for owner. Also we can use one more condition "IS_ENTITY_KIND" to display catalog groups for any user:

- rule - the parameter name is "IS_ENTITY_KIND" in this case.
- resource type: "catalog-entity".
- criteria - "anyOf".
- params - from the schema, it is evident that it should be an object named "kinds" with string array. This string array is a list of catalog kinds. It should be array with single element "Group" in our case.

Based on the above schema:

```json
{
  "anyOf": [
    {
      "rule": "IS_ENTITY_OWNER",
      "resourceType": "catalog-entity",
      "params": {
        "claims": ["group:default/team-a"]
      }
    },
    {
      "rule": "IS_ENTITY_KIND",
      "resourceType": "catalog-entity",
      "params": {
        "kinds": ["Group"]
      }
    }
  ]
}
```

To utilize this condition to the RBAC REST api you need to wrap it with more info:

```json
{
  "result": "CONDITIONAL",
  "roleEntityRef": "role:default/test",
  "pluginId": "catalog",
  "resourceType": "catalog-entity",
  "permissionMapping": ["read"],
  "conditions": {
    "anyOf": [
      {
        "rule": "IS_ENTITY_OWNER",
        "resourceType": "catalog-entity",
        "params": {
          "claims": ["group:default/team-a"]
        }
      },
      {
        "rule": "IS_ENTITY_KIND",
        "resourceType": "catalog-entity",
        "params": {
          "kinds": ["Group"]
        }
      }
    ]
  }
}
```

---

### POST condition

POST </api/permission/roles/conditions>

Creates a new condition.

Request Parameters: condition object in json format described above.

body:

```json
{
  "result": "CONDITIONAL",
  "roleEntityRef": "role:default/test",
  "pluginId": "catalog",
  "resourceType": "catalog-entity",
  "permissionMapping": ["read"],
  "conditions": {
    "rule": "IS_ENTITY_OWNER",
    "resourceType": "catalog-entity",
    "params": {
      "claims": ["group:default/team-a"]
    }
  }
}
```

Returns a status code of 201 and json with id upon success:

```json
{
  "id": 1
}
```

---

### PUT condition

PUT </permission/roles/conditions/:id>

Update conditions by id.

Request Parameters: condition object in json format described above.

body:

```json
{
  "result": "CONDITIONAL",
  "roleEntityRef": "role:default/test",
  "pluginId": "catalog",
  "resourceType": "catalog-entity",
  "permissionMapping": ["read"],
  "conditions": {
    "anyOf": [
      {
        "rule": "IS_ENTITY_OWNER",
        "resourceType": "catalog-entity",
        "params": {
          "claims": ["group:default/team-a"]
        }
      },
      {
        "rule": "IS_ENTITY_KIND",
        "resourceType": "catalog-entity",
        "params": {
          "kinds": ["Group"]
        }
      }
    ]
  }
}
```

Returns a status code of 200 upon success.

---

### Get condition by id

GET </api/permission/roles/conditions/:id>

Returns condition by id:

```json
{
  "id": 1,
  "result": "CONDITIONAL",
  "roleEntityRef": "role:default/test",
  "pluginId": "catalog",
  "resourceType": "catalog-entity",
  "permissionMapping": ["read"],
  "conditions": {
    "anyOf": [
      {
        "rule": "IS_ENTITY_OWNER",
        "resourceType": "catalog-entity",
        "params": {
          "claims": ["group:default/team-a"]
        }
      },
      {
        "rule": "IS_ENTITY_KIND",
        "resourceType": "catalog-entity",
        "params": {
          "kinds": ["Group"]
        }
      }
    ]
  }
}
```

Returns a status code of 200 upon success.

---

### GET conditions

GET </api/permission/roles/conditions>

Returns lists all conditions:

```json
[
  {
    "id": 1,
    "result": "CONDITIONAL",
    "roleEntityRef": "role:default/test",
    "pluginId": "catalog",
    "resourceType": "catalog-entity",
    "permissionMapping": ["read"],
    "conditions": {
      "anyOf": [
        {
          "rule": "IS_ENTITY_OWNER",
          "resourceType": "catalog-entity",
          "params": {
            "claims": ["group:default/team-a"]
          }
        },
        {
          "rule": "IS_ENTITY_KIND",
          "resourceType": "catalog-entity",
          "params": {
            "kinds": ["Group"]
          }
        }
      ]
    }
  }
]
```

Returns a status code of 200 upon success.

---

### DELETE condition by id

DELETE </api/permission/roles/conditions/:id>

Deletes condition by id.

Returns a status code of 204 upon success.

## HTTP status codes

| Code | Descriptions                                    |
| ---- | ----------------------------------------------- |
| 200  | Request was successful                          |
| 201  | New resource was successfully created           |
| 204  | No additional content to send in response       |
| 400  | Input Error                                     |
| 401  | Lacks valid authentication                      |
| 403  | Refusal to authorize                            |
| 404  | Could not find resource                         |
| 409  | Conflict with current state and target resource |

---
