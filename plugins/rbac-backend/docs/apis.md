# APIs

## Requirements

To access the APIs for the RBAC Backend plugin, a user will need to have admin access. Refer to the [README](../README.md#configure-policy-admins) on how to set up admin access.

Each endpoint also requires an Authorization header with the Bearer token that was generated by Backstage. To access this token, traverse to your deployed instance and inspect the web page. Here are two places and example network calls that will have the Bearer token

- From the Homepage, the network call `query?term=`

- From the Catalog, any network call with `entity-facets`

## Role

### GET role

GET </api/permission/roles>

lists all roles.

Returns:

```json
[
  {
    "memberReferences": ["user:default/adam"],
    "name": "role:default/guests"
  },
  {
    "memberReferences": ["group:default/janus-authors", "user:default/matt"],
    "name": "role:default/test"
  }
]
```

---

GET </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test>

List the single role and the members associated with that role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Returns:

```json
[
  {
    "memberReferences": ["group:default/janus-authors", "user:default/matt"],
    "name": "role:default/test"
  }
]
```

---

### POST role

POST </api/permission/roles>

Creates a new role.

Request Parameters:

| Parameter name   | Description                                                      | Type   |
| ---------------- | ---------------------------------------------------------------- | ------ |
| memberReferences | users / groups to be added to the role `<kind>:<default>/<name>` | Array  |
| name             | name of the role                                                 | String |

body:

```json
{
  "memberReferences": ["group:default/test"],
  "name": "role:default/test_admin"
}
```

Returns a status code of 201 upon success.

---

### PUT role

PUT </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin>

Updates a specified role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Request Parameters for oldRole and newRole:

| Parameter name   | Description                                                      | Type   |
| ---------------- | ---------------------------------------------------------------- | ------ |
| memberReferences | users / groups to be added to the role `<kind>:<default>/<name>` | Array  |
| name             | name of the role                                                 | String |

body:

```json
{
  "oldRole": {
    "memberReferences": ["group:default/test"],
    "name": "role:default/test_admin"
  },
  "newRole": {
    "memberReferences": ["group:default/test", "user:default/test2"],
    "name": "role:default/test_admin"
  }
}
```

Returns a status code of 200 upon success.

---

### DELETE role

DELETE </api/permission/roles/:kind/:namespace/:name?memberReferences=VALUE>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin?memberReferences=user:default/test2>

Deletes a single user / group from a role.

Request Parameters:

| Parameter name   | Description                                                      | Type   |
| ---------------- | ---------------------------------------------------------------- | ------ |
| kind             | role                                                             | String |
| namespace        | Namespace of the role                                            | String |
| name             | name of the role                                                 | String |
| memberReferences | users / groups to be added to the role `<kind>:<default>/<name>` | String |
| name             | name of the role                                                 | String |

before:

```json
{
  "memberReferences": ["group:default/test, user:default/test2"],
  "name": "role:default/test_admin"
}
```

after:

```json
{
  "memberReferences": ["group:default/test"],
  "name": "role:default/test_admin"
}
```

Returns a status code of 204 upon success.

---

DELETE </api/permission/roles/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/roles/role/default/test_admin>

Deletes a single role and all users associated with that role.

Request Parameters:

| Parameter name | Description           | Type   |
| -------------- | --------------------- | ------ |
| kind           | role                  | String |
| namespace      | Namespace of the role | String |
| name           | name of the role      | String |

Returns a status code of 204 upon success.

---

## Permission

### GET permission

GET </api/permission/policies>

lists all permission polices.

Returns:

```json
[
  {
    "entityReference": "role:default/test",
    "permission": "catalog-entity",
    "policy": "read",
    "effect": "allow"
  },
  {
    "entityReference": "role:default/test",
    "permission": "catalog.entity.create",
    "policy": "create",
    "effect": "allow"
  },
  ...
]
```

---

GET </api/permission/policies/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/policies/role/default/test>

List permission policies related to the specified entity reference `<kind>:<default>/<name>`.

Request parameters:

| Parameter name | Description             | Type   |
| -------------- | ----------------------- | ------ |
| kind           | Kind of the entity      | String |
| namespace      | Namespace of the entity | String |
| name           | Username of the entity  | String |

Returns:

```json
[
  {
    "entityReference": "role:default/test",
    "permission": "catalog-entity",
    "policy": "read",
    "effect": "allow"
  },
  {
    "entityReference": "role:default/test",
    "permission": "catalog.entity.create",
    "policy": "create",
    "effect": "allow"
  }
]
```

---

### POST permission

POST </api/permission/policies>

Creates a permission policy for a specified entity.

Request parameters:

| Parameter name  | Description                                                                   | Type   |
| --------------- | ----------------------------------------------------------------------------- | ------ |
| entityReference | Entity `<kind>:<default>/<name>`                                              | String |
| permission      | Permission from a specific plugin, Resource type or name                      | String |
| policy          | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect          | `allow` or `deny`                                                             | String |

body:

```json
{
  "entityReference": "role:default/test",
  "permission": "catalog-entity",
  "policy": "read",
  "effect": "allow"
}
```

Returns a status code of 201 upon success.

---

### PUT permission

PUT </api/permission/policies/:kind/:namespace/:name>
ex. <http://localhost:7007/api/permission/policies/role/default/test>

Updates a permission policy for a specified entity.

Request parameters:

| Parameter name | Description             | Type   |
| -------------- | ----------------------- | ------ |
| kind           | Kind of the entity      | String |
| namespace      | Namespace of the entity | String |
| name           | Username of the entity  | String |

Request parameters for oldPolicy and newPolicy objects:

| Parameter name | Description                                                                   | Type   |
| -------------- | ----------------------------------------------------------------------------- | ------ |
| permission     | Permission from a specific plugin, Resource type or name                      | String |
| policy         | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect         | `allow` or `deny`                                                             | String |

body:

```json
{
  "oldPolicy": {
    "permission": "catalog-entity",
    "policy": "read",
    "effect": "deny"
  },
  "newPolicy": {
    "permission": "policy-entity",
    "policy": "read",
    "effect": "allow"
  }
}
```

Returns a status code of 200 upon success.

---

### Delete permission

DELETE </api/permission/policies/:kind/:namespace/:name?permission=VALUE1&policy=VALUE2&effect=VALUE3>
ex. <http://localhost:7007/api/permission/policies/role/default/test?permission=catalog-entity&policy=read&effect=allow>

Deletes a permission policy of a specified entity.

Request Parameters:

| Parameter name | Description                                                                   | Type   |
| -------------- | ----------------------------------------------------------------------------- | ------ |
| kind           | Kind of the entity                                                            | String |
| namespace      | Namespace of the entity                                                       | String |
| name           | Username of the entity                                                        | String |
| permission     | Permission from a specific plugin, Resource type or name                      | String |
| policy         | Policy action for the permission, `create`, `read`, `update`, `delete`, `use` | String |
| effect         | `allow` or `deny`                                                             | String |

Returns a status code of 204 upon success.

---

## Plugin

### GET plugin permission policies

GET </api/permission/plugins/policies>

lists all plugin permission policies from plugins installed in your Backstage instance.

Returns:

```json
[
  {
    "pluginId": "catalog",
      "policies": [
        {
          "permission": "catalog-entity",
          "policy": "read"
        },
        {
          "permission": "catalog.entity.create",
          "policy": "create"
        },
        {
          "permission": "catalog-entity",
          "policy": "delete"
        },
        {
          "permission": "catalog-entity",
          "policy": "update"
        },
        {
          "permission": "catalog.location.read",
          "policy": "read"
        },
        {
          "permission": "catalog.location.create",
          "policy": "create"
        },
        {
          "permission": "catalog.location.delete",
          "policy": "delete"
        }
      ]
    },
  ...
]
```

---

## HTTP status codes

| Code | Descriptions                                    |
| ---- | ----------------------------------------------- |
| 200  | Request was successful                          |
| 201  | New resource was successfully created           |
| 204  | No additional content to send in response       |
| 400  | Input Error                                     |
| 401  | Lacks valid authentication                      |
| 403  | Refusal to authorize                            |
| 404  | Could not find resource                         |
| 409  | Conflict with current state and target resource |

---
