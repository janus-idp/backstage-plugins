name: Push website

on:
  push:
    branches:
      - main
    paths:
      - '**/README.md'

concurrency:
  group: push-website
  cancel-in-progress: true

jobs:
  build-website:
    name: Build website
    runs-on: ubuntu-latest
    steps:
      - name: Checkout janus-idp/backstage-plugins
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: plugins

      - name: Checkout janus-idp/janus-idp.github.io
        uses: actions/checkout@v3
        with:
          repository: janus-idp/janus-idp.github.io
          persist-credentials: false
          fetch-depth: 0
          path: website

      - name: Build
        uses: ./plugins/.github/actions/build-website

  dispatch-website:
    name: Dispatch website
    needs:
      - build-website
    runs-on: ubuntu-latest
    steps:
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PAT }}
          repository: janus-idp/janus-idp.github.io
          event-type: deploy-website
          client-payload: '{"github": ${{ toJson(github) }}}'
